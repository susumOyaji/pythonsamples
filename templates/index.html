<!DOCTYPE html>
<html>
<head>
    <title>株価情報</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>株価情報</h1>

    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}

    <h2>株式を追加</h2>
    <div>
        <label for="tickerInput">ティッカー:</label>
        <input type="text" id="tickerInput"><br><br>

        <label for="sharesInput">株数:</label>
        <input type="number" id="sharesInput" min="1"><br><br>

        <label for="purchasePriceInput">取得金額:</label>
        <input type="number" step="0.01" id="purchasePriceInput"><br><br>

        <button onclick="addStockFromForm()">追加</button>
    </div>

    <ul id="stockList">
        </ul>

    <script>
        function getStockData() {
            const stocks = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('stock_')) {
                    const stockData = JSON.parse(localStorage.getItem(key));
                    stocks.push(stockData);
                }
            }

            const formData = new FormData();
            formData.append('stock_data', JSON.stringify(stocks));

            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                response.text().then(text => {
                    console.log('サーバーからのレスポンス (テキスト):', text); // ★ 追加
                    try {
                        const data = JSON.parse(text);
                        console.log('サーバーからのレスポンス (JSON):', data); // ★ 追加
                        const stockTableBody = document.getElementById('stockTableBody');
                        if (stockTableBody && data.stocks) {
                            let tableHTML = '';
                            data.stocks.forEach(stock => {
                                tableHTML += `
                                    <tr>
                                        <td>${stock.ticker}</td>
                                        <td>${stock.timestamp}</td>
                                        <td>${stock.price}</td>
                                        <td>${stock.change}</td>
                                        <td>${stock.change_percent}</td>
                                        <td>${stock.shares}</td>
                                        <td>${stock.purchase_price}</td>
                                    </tr>
                                `;
                            });
                            stockTableBody.innerHTML = tableHTML;
                        }
                    } catch (error) {
                        console.error('JSONパースエラー:', error);
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        window.onload = getStockData;
        setInterval(getStockData, 5000);

        function addStockFromForm() {
            const ticker = document.getElementById('tickerInput').value.toUpperCase();
            const shares = parseInt(document.getElementById('sharesInput').value);
            const purchasePrice = parseFloat(document.getElementById('purchasePriceInput').value);

            if (ticker && shares > 0 && !isNaN(purchasePrice)) {
                const newStock = { ticker: ticker, shares: shares, purchase_price: purchasePrice };
                localStorage.setItem('stock_' + Date.now(), JSON.stringify(newStock));
                document.getElementById('tickerInput').value = '';
                document.getElementById('sharesInput').value = '';
                document.getElementById('purchasePriceInput').value = '';
                getStockData(); // データ追加後に更新
            } else {
                alert('入力内容に誤りがあります。ティッカー、株数（1以上）、取得金額を正しく入力してください。');
            }
        }
    </script>

   {% if stocks %}
    <h2>取得した株価情報</h2>
    <table>
        <thead>
            <tr>
                <th>ティッカー</th>
                <th>現在時刻</th>
                <th>現在株価</th>
                <th>前日比</th>
                <th>前日比 (%)</th>
                <th>保有株数</th>
                <th>取得金額</th>
            </tr>
        </thead>
        <tbody id="stockTableBody">
            </tbody> </table>
    {% endif %}

</body>
</html>